services:
  laravel.test:
    build:
      context: './vendor/laravel/sail/runtimes/8.4'
      dockerfile: Dockerfile
      args:
        WWWGROUP: '${WWWGROUP}'
    image: 'sail-8.4/app'
    container_name: pnedu-app
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    ports:
      - '8081:80'
      - '5174:5174'
    environment:
      WWWUSER: '${WWWUSER}'
      LARAVEL_SAIL: 1
      XDEBUG_MODE: '${SAIL_XDEBUG_MODE:-off}'
      XDEBUG_CONFIG: '${SAIL_XDEBUG_CONFIG:-client_host=host.docker.internal}'
      IGNITION_LOCAL_SITES_PATH: '${PWD}'
    volumes:
      - '.:/var/www/html'
      - '../pne-certificate-generator:/var/www/pne-certificate-generator'
    networks:
      - sail
      - pne-network
    depends_on:
      - redis
      - mailpit
      - selenium
    # UWAGA: Nie ma depends_on: mysql - używamy MySQL z pneadm-bootstrap (kontener pneadm-mysql)

  # USUNIĘTO: Kontener MySQL - używamy wspólnego MySQL z pneadm-bootstrap
  # mysql:
  #   ...

  redis:
    image: 'redis:alpine'
    ports:
      - '${FORWARD_REDIS_PORT:-6379}:6379'
    volumes:
      - 'sail-redis:/data'
    networks:
      - sail
    healthcheck:
      test:
        - CMD
        - redis-cli
        - ping
      retries: 3
      timeout: 5s

  mailpit:
    image: 'axllent/mailpit:latest'
    ports:
      - '1026:1025'
      - '${FORWARD_MAILPIT_DASHBOARD_PORT:-8025}:8025'
    networks:
      - sail

  selenium:
    image: selenium/standalone-chromium
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    volumes:
      - '/dev/shm:/dev/shm'
    networks:
      - sail

  phpmyadmin:
    build:
      context: .
      dockerfile: Dockerfile.phpmyadmin
    # UWAGA: Nie ma depends_on - MySQL jest w pneadm-bootstrap
    environment:
      PMA_HOST: pneadm-mysql
      PMA_USER: ${DB_PNEADM_USERNAME:-sail}
      PMA_PASSWORD: ${DB_PNEADM_PASSWORD:-password}
      PMA_ARBITRARY: 1
      UPLOAD_LIMIT: 100M
      MAX_EXECUTION_TIME: 600
      MEMORY_LIMIT: 512M
    ports:
      - '8082:80'
    networks:
      - sail
      - pne-network
    # UWAGA: MySQL jest w kontenerze pneadm-mysql z pneadm-bootstrap
    # PMA_ARBITRARY: 1 pozwala na dostęp do wszystkich baz, do których użytkownik ma uprawnienia

  mysql-backup:
    image: fradelg/mysql-cron-backup
    # UWAGA: Nie ma depends_on - MySQL jest w pneadm-bootstrap
    environment:
      - MYSQL_HOST=pneadm-mysql
      - MYSQL_USER=${DB_PNEADM_USERNAME:-sail}
      - MYSQL_PASS=${DB_PNEADM_PASSWORD:-password}
      - MYSQL_DB=${DB_PNEADM_DATABASE:-pneadm}
      - CRON_TIME=0 2 * * *
      - MAX_BACKUPS=7
    volumes:
      - ./mysql-backups:/backup
    networks:
      - pne-network
    # UWAGA: Używa MySQL z kontenera pneadm-mysql z pneadm-bootstrap

networks:
  sail:
    driver: bridge
  pne-network:
    external: true

volumes:
  # USUNIĘTO: sail-mysql - używamy wspólnego volume z pneadm-bootstrap
  sail-redis:
    driver: local
